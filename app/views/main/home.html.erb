<% provide(:title, "Home") %>
<%= content_for(:body_attributes, 'data-no-turbolink = "true"') %>
      
      <div class="row" style="padding-top:20px;">
        <div class="col-md-3"> <h1 id="dashboard-head">Dashboard</h1> </div>
          <button type="button" class="new-widget pull-right btn btn-primary" href ="#widgetsList"> Add New Widgets </button>
      </div>
      <hr>

      <div id = "grid" class="grid-stack">
      </div>

        <div id="widgetsList" class="modal fade" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add widget</h4>
              </div>
              <div class="modal-body">
                <button onClick="addAnimalWidget()" type="button" class="btn btn-info btn-lg">Animals Widget</button>
                <button onClick="addAlertsWidget()" type="button" class="btn btn-primary btn-lg">Alerts Widget</button>
                <button onClick="addUserWidget()" type="button" class="btn btn-warning btn-lg">User Widget</button>
                <button onClick="addStatusWidget()" type="button" class="btn btn-warning btn-lg">Status Count Widget</button>
                 <button onClick="addCoorWidget()" type="button" class="btn btn-warning btn-lg">My Assigned Animals</button>


              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>
            </div>
          </div>
        </div>


<script>
var grid;




function saveLayout() {
    var arr = []
    $(".grid-stack-item").each(function() {
        var type = $(this).attr("widget-type");
        var x = $(this).attr("data-gs-x");
        var y = $(this).attr("data-gs-y");
        var width = $(this).attr("data-gs-width");
        var height = $(this).attr("data-gs-height");
        arr.push({"type": type, "x": x, "y": y, "width": width, "height": height});

    })
    var str = JSON.stringify(arr);
    $.ajax({

        url: "dashboard",
        type: "PATCH",
        data: {"str": str},
       success: function(result){
       },
       error: function(){
        console.log("failed")
       }
     })


}



function addAnimalWidget() {
    var el = $.parseHTML('<div class="grid-stack-item" widget-type = "animal-list" data-gs-x="0" data-gs-y="0" data-gs-width="5" data-gs-height="4"><div class="grid-stack-item-content animal-list panel"></div></div>');
    grid.addWidget(el, 0, 0, 5, 4, true);
    widgetAnimalList()
}

function addCoorWidget() {
    var el = $.parseHTML('<div class="grid-stack-item" widget-type = "coor-list" data-gs-x="0" data-gs-y="0" data-gs-width="5" data-gs-height="4"><div class="grid-stack-item-content coor-list panel"></div></div>');
    grid.addWidget(el, 0, 0, 5, 4, true);
    widgetCoorList()
}
function addStatusWidget() {
    var el = $.parseHTML('<div class="grid-stack-item" widget-type = "status-list" data-gs-x="0" data-gs-y="0" data-gs-width="9" data-gs-height="4"><div class="grid-stack-item-content status-list panel"></div></div>');
    grid.addWidget(el, 0, 0, 9, 4, true);
    widgetStatusList()
}

function addAlertsWidget() {
    

     var el = $.parseHTML('<div class="grid-stack-item" widget-type = "alert-list" data-gs-x="0" data-gs-y="0" data-gs-width="5" data-gs-height="4"><div class="grid-stack-item-content alert-list panel panel-default"></div></div>');
    grid.addWidget(el, 0, 0, 5, 4, true);
    widgetAlertList()


}

function addUserWidget() {
    var el = $.parseHTML('<div class="grid-stack-item" widget-type = "user-list" data-gs-x="0" data-gs-y="0" data-gs-width="5" data-gs-height="4"><div class="grid-stack-item-content user-list panel panel-default"></div></div>');
    grid.addWidget(el, 0, 0, 5, 4, true);
    widgetUserList()
}

function drop(event) {
    saveLayout()
}




if($(".animal-list").length > 0) {
    widgetAnimalList();
}
if($(".user-list").length > 0){
    widgetUserList();
}
if($(".status-list").length > 0){
    widgetStatusList();
}
if($(".coor-list").length > 0){
    widgetCoorList();
}
if($(".alert-list").length > 0){
    widgetAlertList();
}

$(".new-widget").on("click", function(){
  $('#widgetsList').modal('show')    
})

function widgetAnimalList(){
    $.ajax({url: "animals/querySimple", success: function(result){
        var str = "<div class='panel-heading'> <h3 class= 'panel-title pull-left'> Animals</h3><div class='right'><button type='button' class='remove-item-btn' onclick='return false;'><i class='lnr lnr-cross'></i></button></div></div>"

        str += "<div class='panel-body no-padding'> <div class='table-responsive'> <table class='table table-hover table-striped'> <thead> <tr> <th>Name</th> <th>Primary Breed</th> <th>Age</th> </tr> </thead>" 
        for (x in result){
    
                str += "<tr> \
                <td> <a href='/animals/profile?method=get&param=" + result[x].id + " '  >" + result[x].name + "</a></td>\
                 <td>" + result[x].primary + "</td>\
                <td>" + result[x].age + "</td>\
                </tr>"
        }
        str +=  " </table> </div> <div class='text-right panel-footer'> <div class='row text-right'><a href= animals class='btn btn-primary'>View all Animals</a> </div></div>"

         $(".animal-list").each(function(){
            $(this).html( str)
         })
         bindRemove();
    }});
}

function widgetCoorList(){
    $.ajax({url: "animals/querySimpleCoor", success: function(result){
        var str = "<div class='panel-heading'> <h3 class= 'panel-title pull-left'> My Assigned Animals</h3><div class='right'><button type='button' class='remove-item-btn' onclick='return false;'><i class='lnr lnr-cross'></i></button></div></div>"

        str += "<div class='panel-body no-padding'> <div class='table-responsive'> <table class='table table-hover table-striped'> <thead> <tr> <th>Name</th> <th>Primary Breed</th> <th>Age</th> </tr> </thead>" 
        for (x in result){
    
                str += "<tr> \
                <td> <a href='/animals/profile?method=get&param=" + result[x].id + " '  >" + result[x].name + "</a></td>\
                 <td>" + result[x].primary + "</td>\
                <td>" + result[x].age + "</td>\
                </tr>"
        }
        str +=  " </table> </div> <div class='text-right panel-footer'> <div class='row text-right'><a href= animals class='btn btn-primary'>View all Animals</a> </div></div>"

         $(".coor-list").each(function(){
            $(this).html( str)
         })
         bindRemove();
    }});
}

function widgetStatusList(){
    $.ajax({url: "animals/querySimpleStatus", success: function(result){
        var str = "<div class='panel panel-scrolling'><div class='panel-heading'> <h3 class= 'panel-title pull-left'> Status Count</h3><div class='right'><button type='button' class='remove-item-btn' onclick='return false;'><i class='lnr lnr-cross'></i></button></div></div>"

        str += "<div class='grid-stack-item-content panel-body'><div class='row'>" 

        for (x in result){
    
                str += "<div class='col-md-4'><div class='metric'><span class='icon'><i class='glyphicon glyphicon-tasks'></i><a href='/animals?n=+&?b=&?g=&?s=" + result[x].id + "&?a=0&?A=15&?qn=1 '></span><p><span class='number'>" + result[x].count + "</span><span class='title'>" + result[x].name + "</p></div></div>"
    
        }
        str +=  "</div></div><div class='text-right panel-footer'> <div class='row text-right'><a href= animals class='btn btn-primary'>View all Animals</a> </div></div>"

         $(".status-list").each(function(){
            $(this).html( str)
         })
         bindRemove();
    }});
}




function widgetUserList(){
    $.ajax({url: "people/query", success: function(result){
        var str = "<div class='panel-heading'> <h3 class= 'panel-title pull-left'> Users</h3><div class='right'><button type='button' class='remove-item-btn' onclick='return false;'><i class='lnr lnr-cross'></i></button></div></div>"

        str += "<div class='panel-body no-padding'> <div class='table-responsive'> <table class='table table-hover table-striped'> <thead> <tr> <th>Name</th> <th>Email</th> </tr> </thead>" 

        for (x in result){
    
                str += "<tr> \
                <td> <a href='/people/profile?method=get&param=" + result[x].id + "' > " + result[x].name + "</a></td>\
                 <td>" + result[x].email + "</td>\
                </tr>"
        }
        str +=  " </table> </div> <div class='text-right panel-footer'> <div class='row text-right'><a href= people class='btn btn-primary'>View all Users</a> </div></div>"

         $(".user-list").each(function(){
            $(this).html( str)
         })
         bindRemove();
    }});
}

function widgetAlertList(){
    $.ajax({url: "/alerts/query", success: function(result){
        var str = "<div class='panel-heading'> <h3 class= 'panel-title pull-left'> Alerts</h3><div class='right'><button type='button' class='remove-item-btn' onclick='return false;'><i class='lnr lnr-cross'></i></button></div></div>"

        str += "<div class='panel-body no-padding'> <div class='table-responsive'> <table class='table table-hover table-striped'> <thead> <tr> <th>Title</th> <th>Date</th> </tr> </thead>" 

        for (x in result){
    
                str += "<tr> \
                <td> <a href = '#' class = 'alert-event' id = 'alert-" + result[x].id + "'> " + result[x].title + "</a></td>\
                 <td>" + result[x].date + "</td>\
                </tr>"
        }
        str +=  " </table> </div> <div class='text-right panel-footer'> <div class='row text-right'><a href= alerts class='btn btn-warning'>View all Alerts</a> </div></div>"

         $(".alert-list").each(function(){
            $(this).html( str)
         })
         bindRemove();
         bindAlertsModal();
    }});
}

function bindRemove(){
  $('.remove-item-btn').on('click', function(event) {
    console.log("removing")
    $(this).closest('.grid-stack-item').remove()
    saveLayout();
  })
}

$('.grid-stack').on('change', function(event, items) {
  saveLayout();
});

function activateWidgets(){
  widgetAlertList();
  widgetUserList();
  widgetAnimalList();
  widgetStatusList();
  widgetCoorList();
}
function loadWidgets(){
  console.log("loading widgets")
  $.ajax({

        url: "dashboard",
        type: "GET",
       success: function(result){

        str = result.str;
        obj = JSON.parse(str);
        console.log(obj)
        for (i = 0; i < obj.length; i++){
          


          var el = $.parseHTML('<div class="grid-stack-item" widget-type = "' + obj[i].type + '" data-gs-x="'+ obj[i].x+'" data-gs-y="'+ obj[i].y +'" data-gs-width="' + obj[i].width + '" data-gs-height="' +obj[i].height+'"><div class="grid-stack-item-content '+obj[i].type+' panel panel-default"></div></div>');
          $("#grid").append(el);


        }

        $(function () {
            var options = {
                cell_height: 80,
                vertical_margin: 10
            };
            grid = $('.grid-stack').gridstack(options);
            grid = grid.data("gridstack");

          
        });

        activateWidgets();
       },
       error: function(){
        console.log("failed")
       }
     })

}

loadWidgets();
</script>